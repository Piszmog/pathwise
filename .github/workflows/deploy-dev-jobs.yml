name: Deploy Dev Jobs
on:
  push:
    branches:
      - main
    paths:
      - 'internal/jobs/**'
      - 'cmd/jobs/**'
      - 'internal/db/**'
      - 'internal/logger/**'
      - 'internal/version/**'
      - 'internal/context_key/**'
      - 'internal/testutil/**'
      - 'sqlc.yml'
      - 'go.mod'
      - 'go.sum'
  workflow_dispatch:
concurrency:
  group: deploy-dev-jobs
  cancel-in-progress: false
jobs:
  build:
    name: Build Jobs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v6
        with:
          go-version-file: 'go.mod'
          cache: false
      - name: Run Jobs GoReleaser
        run: |
          docker run \
            --rm \
            -v $PWD:/go/src/github.com/user/repo \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -w /go/src/github.com/user/repo \
            -e GITHUB_TOKEN \
            ghcr.io/goreleaser/goreleaser-cross:latest \
            release --clean --snapshot --skip=publish --config cmd/jobs/.goreleaser.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Upload Jobs Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: pathwise-jobs-dev_Linux_x86_64.tar.gz
          path: goreleaser-dist/pathwise-jobs_Linux_x86_64.tar.gz
          retention-days: 1
  deploy-dev-jobs:
    name: Deploy Dev Jobs to VM
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: pathwise-jobs-dev_Linux_x86_64.tar.gz
          path: ./artifacts

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create systemd service file
        run: |
          cat > pathwise-jobs-dev.service << 'EOF'
          [Unit]
          Description=Pathwise Jobs Processor - Dev
          After=network.target

          [Service]
          Type=simple
          User=ubuntu
          WorkingDirectory=/home/ubuntu/apps/pathwise-jobs-dev
          ExecStart=/home/ubuntu/apps/pathwise-jobs-dev/pathwise-jobs
          Restart=always
          RestartSec=5
          Environment=DB_TOKEN=${{ secrets.DEV_DB_TOKEN }}
          Environment=DB_PRIMARY_URL=${{ secrets.DEV_DB_URL }}
          Environment=ENC_KEY=${{ secrets.ENC_KEY }}
          Environment=GEMINI_API_KEY=${{ secrets.DEV_GEMINI_API_KEY }}
          Environment=LOG_OUTPUT=/var/log/pathwise/pathwise-jobs-dev.log
          Environment=PORT=8084

          [Install]
          WantedBy=multi-user.target
          EOF

      - name: Deploy to VM
        run: |
          # Copy artifact and service file to VM
          scp ./artifacts/pathwise-jobs_Linux_x86_64.tar.gz ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/pathwise-jobs-dev_Linux_x86_64.tar.gz
          scp pathwise-jobs-dev.service ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/

          # Extract and deploy on VM
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            # Stop existing dev service if it exists
            if sudo systemctl is-active --quiet pathwise-jobs-dev; then
              sudo systemctl stop pathwise-jobs-dev
            fi

            # Create dev app directory if it doesn't exist
            mkdir -p /home/ubuntu/apps/pathwise-jobs-dev

            # Extract new version
            cd /tmp
            tar -xzf pathwise-jobs-dev_Linux_x86_64.tar.gz

            # Move binary to dev app directory
            mv pathwise-jobs /home/ubuntu/apps/pathwise-jobs-dev/
            chmod +x /home/ubuntu/apps/pathwise-jobs-dev/pathwise-jobs

            # Create log directory if it doesn't exist
            sudo mkdir -p /var/log/pathwise
            sudo chown ubuntu:ubuntu /var/log/pathwise

            # Install systemd service file
            sudo mv /tmp/pathwise-jobs-dev.service /etc/systemd/system/
          EOF

          # Start service and check status
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            # Reload systemd and start dev service
            sudo systemctl daemon-reload
            sudo systemctl start pathwise-jobs-dev
            sudo systemctl enable pathwise-jobs-dev

            # Check status
            sudo systemctl status pathwise-jobs-dev
            # Wait for service to start
            sleep 10
            # Health check
            if curl -f http://localhost:8084/health; then
              echo "✅ Dev health check passed - app is running on port 8084"
            else
              echo "❌ Dev health check failed - app is not responding on port 8084"
              exit 1
            fi
          EOF
      - name: Cleanup
        run: |
          rm -f ~/.ssh/id_rsa
